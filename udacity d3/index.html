<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
      circle {
        stroke: black;
        stroke-width: 0.7;
        opacity: 0.5;
      }
      
      h2 {
        text-align: center;
        color: black;
      }
      
      div.years_buttons {
        position: fixed;
        top: 60px;
        left: 1050px;
      }
      
      div.years_buttons div {
        background-color: "gray";
        padding: 3px;
        margin: 7px;
      }
      
      div.tooltip {	
        position: absolute;			
        text-align: left;			
        width: 200px;					
        height: 100px;					
        padding: 2px;				
        font: 12px sans-serif;		
        background: rgb(240,240,240);	
        border: 0px;		
        border-radius: 8px;			
        pointer-events: none;			
    }
    </style>
    <script type="text/javascript">  
      function draw(geo_data) {
        "use strict";
        var margin = 75,
            width = 1400 - margin,
            height = 600 - margin;

        var light_gray = "rgb(220,220,220)"
        var title_text = "Number of Flights (size) and Average Departure Delay (color) ";
        
        var number_format = d3.format("0,000");
        
        d3.select("body")
            .append("h2")
            .text(title_text)
        
        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');

        var projection = d3.geo.albersUsa()

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', light_gray)
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);
        
        // Define the div for the tooltip
        var div = d3.select("body")
                    .append("div")	
                    .attr("class", "tooltip")				
                    .style("opacity", 0);
        
        /*
        * draw_airports
        */
        function draw_airports(data){
          
          var data_coords = data.map(function(d){
            
            try{
              var coordinates = projection([d['Longitude'],                                         d['Latitude']]);
              d['x'] = coordinates[0];
              d['y'] = coordinates[1];  
            } catch (err) {
                console.log("error when projecting coordinates");
                console.log(d)
              }
            
            return d;
          });
          
          var flight_count_upper = 
              d3.max(data,function(d){
            return d['DepDelay_count'];
          });
          
          var flight_count_lower = 
              d3.min(data,function(d){
            return d['DepDelay_count'];
          });
          
          var radius = d3.scale.sqrt()
                        .domain([flight_count_lower,
                                flight_count_upper])
                        .range([3,30])
                              
          //set circle color based on delay range
          function airport_color(d) {
            if( d['DepDelay_mean'] <=0){
              return "green";
            } else if(d['DepDelay_mean'] <=5){
              return "yellow";
            } else if(d['DepDelay_mean'] <=10){
              return "orange";
            } else{
              return "red";
            }
          } //end airport_color()
          
            var legend_data = ["Early", 
                     "< 5 minute delay", 
                     "< 10 minute delay", 
                     "10 minute delay or more"];
          
            var legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(" + (800) + "," + 400 + ")")
                .selectAll("g")
                .data(legend_data)
                .enter().append("g");

            legend.append("circle")
                .attr("class", "legend_circle")
                .attr("cy", function(d, i) {
                    return i * 30;
                })
                .attr("r", 5)
                .attr("fill", function(d) {
                    if (d == "Early") {
                        return 'green';
                    } else if (d == "< 5 minute delay") {
                        return 'yellow';
                    } else if (d == "< 10 minute delay"){
                      return 'orange';
                    } else if (d == "10 minute delay or more"){
                      return 'red';
                    }
                });

            legend.append("text")
                .attr("y", function(d, i) {
                    return i * 30 + 5;
                })
                .attr("x", 5 * 5)
                .text(function(d) {
                    return d;
                });

          /**
          * update
          */
          function update(year){
            var data_one_year = data_coords.filter(function(d){
              return d['Year'] === year
            });
            
            d3.select("h2")
                .text(title_text + year)
            
            //remove old circles and add fresh circles
            svg.selectAll('circle.airport').remove();
            
            svg.selectAll('circle.airport')
                .data(data_one_year.sort(function(a,b){
                    return  b['DepDelay_count'] - 
                            a['DepDelay_count'];
                  }))
                .enter()
                .append("circle")
                .attr("class", "airport")
                .attr('cx', function(d){ return d['x']; })
                .attr('cy', function(d){ return d['y']; })
                .attr('r', function(d){
                        return radius(d['DepDelay_count']);
                      })
                .on("mouseover", function(d) {		
                  div.transition()		
                      .duration(200)		
                      .style("opacity", .9);
                  div.html("City: " + d['City'] + "<br/>" +
                  "Airport: " + d['Origin'] + "<br/>" +
                  d['Name'] + "<br/>" +
                  "Delay average: " + number_format(d['DepDelay_mean']) + " m<br/>" +
                  "Longest delay: " + number_format(d['DepDelay_max']) + " m<br/>" +
                  "Number of flights: " + number_format(d['DepDelay_count']) + "<br/>" +
                  "Year: " + d['Year']
                           )	
                      .style("left", (d3.event.pageX +10) + "px")
                      .style("top", (d3.event.pageY +5) + "px");	
                    })				
                .on("mouseout", function(d) {		
                    div.transition()		
                        .duration(200)		
                        .style("opacity", 0);	
                    })
                .style('fill', airport_color)
                .transition()
                .duration(200);
            
            //note that I have to put the .on chained
            //before the .transition and .duration,
            //otherwise I get an TypeError that on is not a function
            
          } //end update()
          
          var years = [];
          for (var i = 1987; i <= 2008; i++){
            years.push(i);
          }
          var year_i = 0;
          var interval_period = 500; //milliseconds
          var transition_period = interval_period / 2;
          var year_interval = setInterval(function(){
              update(years[year_i]);
              year_i++;
              if (year_i >= years.length) {
                clearInterval(year_interval);
                
                //add buttons to select years
                var buttons = d3.select("body")
                        .append("div")
                        .attr("class", "years_buttons")
                        .selectAll("div")
                        .data(years)
                        .enter()
                        .append("div")
                        .style("color", "black")
                        .style("background", light_gray)
                        .text(function(d) {
                            return d;
                        });

                buttons.on("click", function(d) {
                    d3.select(".years_buttons")
                      .selectAll("div")
                      .transition()
                      .duration(transition_period)
                      .style("color", "black")
                      .style("background", light_gray);

                    d3.select(this)
                      .transition()
                      .duration(transition_period)
                      .style("background", "lightBlue")
                      .style("color", "white");
                    update(d);
                });                
              }
            }, interval_period);
          
          
        } //end draw_airports()
        
        
        d3.csv("./data/flight_data_yearly_geo.csv", function(d){

          d['Year'] = +d['Year']; //convert to number
          d['Longitude'] = +d['Longitude'];
          d['Latitude'] = +d['Latitude']; 
          d['ArrDelay_mean'] = +d['ArrDelay_mean'];
          d['ArrDelay_max'] = +d['ArrDelay_max'];
          d['ArrDelay_cum'] = +d['ArrDelay_cum'];
          d['ArrDelay_count'] = +d['ArrDelay_count'];
          d['DepDelay_mean'] = +d['DepDelay_mean'];
          d['DepDelay_max'] = +d['DepDelay_max'];
          d['DepDelay_cum'] = +d['DepDelay_cum'];
          d['DepDelay_count'] = +d['DepDelay_count'];
          
          //Note, I can't create new fields when loading data
          //If I try to, the data passed to the draw function
          //will be null

          
          return d;
        }, draw_airports);
      };
      </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
d3.json("./data/usa_states.json", draw);
  </script>
</body>
</html>
